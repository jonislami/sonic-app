{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jonis/OneDrive/Desktop/sonic-garage/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\r\n\r\ndeclare global {\r\n  // eslint-disable-next-line no-var\r\n  var prisma: PrismaClient | undefined;\r\n}\r\n\r\nexport const prisma =\r\n  globalThis.prisma ??\r\n  new PrismaClient({\r\n    log: [\"error\", \"warn\"],\r\n  });\r\n\r\nif (process.env.NODE_ENV !== \"production\") globalThis.prisma = prisma;\r\n"],"names":[],"mappings":";;;;AAAA;;AAOO,MAAM,SACX,WAAW,MAAM,IACjB,IAAI,gPAAY,CAAC;IACf,KAAK;QAAC;QAAS;KAAO;AACxB;AAEF,wCAA2C,WAAW,MAAM,GAAG"}},
    {"offset": {"line": 63, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jonis/OneDrive/Desktop/sonic-garage/src/app/api/dashboard/route.ts"],"sourcesContent":["import { prisma } from \"@/lib/prisma\";\r\nimport { NextResponse } from \"next/server\";\r\n\r\nfunction ymRange(ym: string) {\r\n  if (!/^\\d{4}-\\d{2}$/.test(ym)) return null;\r\n  const [Y, M] = ym.split(\"-\").map(Number);\r\n  const start = new Date(Y, M - 1, 1);\r\n  const end = new Date(Y, M, 1);\r\n  return { start, end };\r\n}\r\n\r\nexport async function GET(req: Request) {\r\n  const url = new URL(req.url);\r\n  const ym = (url.searchParams.get(\"ym\") ?? \"\").trim();\r\n\r\n  const range = ymRange(ym);\r\n  if (!range) return NextResponse.json({ error: \"ym duhet p.sh. 2026-01\" }, { status: 400 });\r\n\r\n  const { start, end } = range;\r\n\r\n  // ============ Të hyra nga faturat (total rreshta)\r\n  const teHyraAgg = await prisma.faktureRresht.aggregate({\r\n    _sum: { totali: true },\r\n    where: {\r\n      fakture: {\r\n        data: { gte: start, lt: end },\r\n        statusi: { not: \"Anuluar\" },\r\n      },\r\n    },\r\n  });\r\n  const teHyra = Number(teHyraAgg._sum.totali?.toString() ?? 0);\r\n\r\n  // ============ Kosto pjesësh (DALJE)\r\n  const dalje = await prisma.inventarLevizje.findMany({\r\n    where: { data: { gte: start, lt: end }, tipi: \"DALJE\" },\r\n    select: { sasia: true, cmimi: true },\r\n  });\r\n  const kostoPjesesh = dalje.reduce((s, x) => s + Number(x.cmimi.toString()) * Number(x.sasia), 0);\r\n\r\n  const fitimBruto = teHyra - kostoPjesesh;\r\n\r\n  // ============ Shpenzime tjera\r\n  const shpenzimeAgg = await prisma.shpenzim.aggregate({\r\n    _sum: { shuma: true },\r\n    where: { data: { gte: start, lt: end } },\r\n  });\r\n  const shpenzimeTjera = Number(shpenzimeAgg._sum.shuma?.toString() ?? 0);\r\n\r\n  const fitimNeto = fitimBruto - shpenzimeTjera;\r\n\r\n  // ============ Borxhet (fatura me pagesa)\r\n  const faturat = await prisma.fakture.findMany({\r\n    where: { statusi: { not: \"Anuluar\" } },\r\n    include: { rreshta: true, pagesa: true, klient: true },\r\n    orderBy: { data: \"desc\" },\r\n    take: 200,\r\n  });\r\n\r\n  let borxhiTotal = 0;\r\n  const borxheTop = faturat\r\n    .map((f) => {\r\n      const total = f.rreshta.reduce((s, r) => s + Number(r.totali.toString()), 0);\r\n      const paguar = f.pagesa.reduce((s, p) => s + Number(p.shuma.toString()), 0);\r\n      const borxh = total - paguar;\r\n      return {\r\n        faktureId: f.faktureId.toString(),\r\n        nrFakture: f.nrFakture,\r\n        klient: `${f.klient.emri} ${f.klient.mbiemri ?? \"\"}`.trim(),\r\n        borxh,\r\n      };\r\n    })\r\n    .filter((x) => x.borxh > 0.001)\r\n    .sort((a, b) => b.borxh - a.borxh)\r\n    .slice(0, 6);\r\n\r\n  borxhiTotal = borxheTop.reduce((s, x) => s + x.borxh, 0);\r\n\r\n  // ============ Servise Hap (quick list)\r\n  const serviseHap = await prisma.servis.findMany({\r\n    where: { statusi: \"Hap\" },\r\n    orderBy: { dataServisit: \"desc\" },\r\n    take: 8,\r\n    include: { automjet: { include: { klient: true } } },\r\n  });\r\n\r\n  const servise = serviseHap.map((s) => ({\r\n    servisId: s.servisId.toString(),\r\n    dataServisit: s.dataServisit.toISOString(),\r\n    pershkrimi: s.pershkrimi ?? \"\",\r\n    automjet: `${s.automjet.marka ?? \"\"} ${s.automjet.modeli ?? \"\"} ${s.automjet.viti ?? \"\"}`.trim(),\r\n    targa: s.automjet.targa ?? \"\",\r\n    klient: `${s.automjet.klient.emri} ${s.automjet.klient.mbiemri ?? \"\"}`.trim(),\r\n  }));\r\n\r\n  // ============ Low-stock (top 10)\r\n  const inv = await prisma.inventarPjese.findMany({\r\n    orderBy: { sasiaStok: \"asc\" },\r\n    take: 10,\r\n    select: { inventarId: true, emri: true, sasiaStok: true },\r\n  });\r\n\r\n  const lowStock = inv\r\n    .filter((x) => x.sasiaStok <= 2)\r\n    .map((x) => ({\r\n      inventarId: x.inventarId.toString(),\r\n      emri: x.emri,\r\n      sasiaStok: x.sasiaStok,\r\n    }));\r\n\r\n  return NextResponse.json({\r\n    ym,\r\n    cards: {\r\n      teHyra: teHyra.toFixed(2),\r\n      kostoPjesesh: kostoPjesesh.toFixed(2),\r\n      shpenzimeTjera: shpenzimeTjera.toFixed(2),\r\n      fitimNeto: fitimNeto.toFixed(2),\r\n      borxhiTopTotal: borxhiTotal.toFixed(2),\r\n    },\r\n    servise,\r\n    lowStock,\r\n    borxheTop: borxheTop.map((x) => ({\r\n      ...x,\r\n      borxh: x.borxh.toFixed(2),\r\n    })),\r\n  });\r\n}\r\n"],"names":[],"mappings":"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"}}]
}
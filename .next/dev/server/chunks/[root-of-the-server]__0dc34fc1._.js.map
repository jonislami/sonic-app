{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jonis/OneDrive/Desktop/sonic-garage/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\r\n\r\ndeclare global {\r\n  // eslint-disable-next-line no-var\r\n  var prisma: PrismaClient | undefined;\r\n}\r\n\r\nexport const prisma =\r\n  globalThis.prisma ??\r\n  new PrismaClient({\r\n    log: [\"error\", \"warn\"],\r\n  });\r\n\r\nif (process.env.NODE_ENV !== \"production\") globalThis.prisma = prisma;\r\n"],"names":[],"mappings":";;;;AAAA;;AAOO,MAAM,SACX,WAAW,MAAM,IACjB,IAAI,gPAAY,CAAC;IACf,KAAK;QAAC;QAAS;KAAO;AACxB;AAEF,wCAA2C,WAAW,MAAM,GAAG"}},
    {"offset": {"line": 63, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jonis/OneDrive/Desktop/sonic-garage/src/app/api/raporte/ditore/route.ts"],"sourcesContent":["import { prisma } from \"@/lib/prisma\";\r\nimport { NextResponse } from \"next/server\";\r\n\r\nfunction dayRange(d?: string) {\r\n  const now = new Date();\r\n  const base = d\r\n    ? new Date(`${d}T00:00:00`)\r\n    : new Date(now.getFullYear(), now.getMonth(), now.getDate());\r\n\r\n  const start = new Date(base);\r\n  start.setHours(0, 0, 0, 0);\r\n\r\n  const end = new Date(start);\r\n  end.setDate(end.getDate() + 1);\r\n\r\n  const iso = start.toISOString().slice(0, 10);\r\n  return { start, end, iso };\r\n}\r\n\r\n// Pagesa të aplikuara + bakshish (overpay) brenda range\r\nasync function calcAppliedAndTip(start: Date, end: Date) {\r\n  const pays = await prisma.fakturePagesa.findMany({\r\n    where: {\r\n      dataPageses: { gte: start, lt: end },\r\n      fakture: { statusi: { not: \"Anuluar\" } },\r\n    },\r\n    select: { faktureId: true, shuma: true, dataPageses: true },\r\n    orderBy: [{ faktureId: \"asc\" }, { dataPageses: \"asc\" }],\r\n  });\r\n\r\n  if (pays.length === 0) return { pagesaAplikuar: 0, bakshishNgaPagesat: 0 };\r\n\r\n  const faktureIds = Array.from(new Set(pays.map((p) => p.faktureId.toString()))).map((x) => BigInt(x));\r\n\r\n  const totals = await prisma.faktureRresht.groupBy({\r\n    by: [\"faktureId\"],\r\n    where: { faktureId: { in: faktureIds } },\r\n    _sum: { totali: true },\r\n  });\r\n\r\n  const totalMap = new Map<string, number>();\r\n  for (const t of totals) totalMap.set(t.faktureId.toString(), Number(t._sum.totali?.toString() ?? 0));\r\n\r\n  const paidBefore = await prisma.fakturePagesa.groupBy({\r\n    by: [\"faktureId\"],\r\n    where: { faktureId: { in: faktureIds }, dataPageses: { lt: start } },\r\n    _sum: { shuma: true },\r\n  });\r\n\r\n  const paidBeforeMap = new Map<string, number>();\r\n  for (const p of paidBefore) paidBeforeMap.set(p.faktureId.toString(), Number(p._sum.shuma?.toString() ?? 0));\r\n\r\n  let pagesaAplikuar = 0;\r\n  let bakshishNgaPagesat = 0;\r\n\r\n  const runningPaid = new Map<string, number>();\r\n  for (const pid of faktureIds) runningPaid.set(pid.toString(), paidBeforeMap.get(pid.toString()) ?? 0);\r\n\r\n  for (const pay of pays) {\r\n    const id = pay.faktureId.toString();\r\n    const total = totalMap.get(id) ?? 0;\r\n    const already = runningPaid.get(id) ?? 0;\r\n\r\n    const remaining = Math.max(0, total - Math.min(total, already));\r\n    const shumaPay = Number(pay.shuma.toString());\r\n\r\n    const applied = Math.min(shumaPay, remaining);\r\n    const tip = Math.max(0, shumaPay - applied);\r\n\r\n    pagesaAplikuar += applied;\r\n    bakshishNgaPagesat += tip;\r\n\r\n    runningPaid.set(id, already + shumaPay);\r\n  }\r\n\r\n  return { pagesaAplikuar, bakshishNgaPagesat };\r\n}\r\n\r\nexport async function GET(req: Request) {\r\n  try {\r\n    const url = new URL(req.url);\r\n    const d = url.searchParams.get(\"d\") ?? undefined;\r\n    const { start, end, iso } = dayRange(d);\r\n\r\n    // Të hyra (Fatura) = rreshta faturash të asaj dite (krijim fature)\r\n    const faturatTotalAgg = await prisma.faktureRresht.aggregate({\r\n      _sum: { totali: true },\r\n      where: {\r\n        fakture: {\r\n          data: { gte: start, lt: end },\r\n          statusi: { not: \"Anuluar\" },\r\n        },\r\n      },\r\n    });\r\n    const teHyraFatura = Number(faturatTotalAgg._sum.totali?.toString() ?? 0);\r\n\r\n    // Pagesa aplikuar + bakshish (overpay)\r\n    const { pagesaAplikuar, bakshishNgaPagesat } = await calcAppliedAndTip(start, end);\r\n\r\n    // Shpenzime (listë + total)\r\n    const shpenzimeRows = await prisma.shpenzim.findMany({\r\n      where: { data: { gte: start, lt: end } },\r\n      orderBy: { data: \"desc\" },\r\n    });\r\n\r\n    const shpenzimeList = shpenzimeRows.map((x: any) => ({\r\n      shpenzimId: String(x.shpenzimId ?? x.id ?? \"\"),\r\n      data: x.data ? new Date(x.data).toISOString() : null,\r\n      pershkrimi: String(x.pershkrimi ?? x.lloji ?? x.emri ?? \"Shpenzim\"),\r\n      kategoria: x.kategoria ? String(x.kategoria) : null,\r\n      shenim: x.shenim ? String(x.shenim) : null,\r\n      shuma: Number(x.shuma?.toString?.() ?? x.shuma ?? 0),\r\n    }));\r\n\r\n    const shpenzimeTjera = shpenzimeList.reduce((s: number, r: any) => s + (Number(r.shuma) || 0), 0);\r\n\r\n    // ✅ DALJE inventari me cmimi blerje + cmimi shitje + fitim\r\n    const daljeRows = await prisma.inventarLevizje.findMany({\r\n      where: { data: { gte: start, lt: end }, tipi: \"DALJE\" },\r\n      orderBy: { data: \"desc\" },\r\n      select: {\r\n        levizjeId: true,\r\n        data: true,\r\n        sasia: true,\r\n        shenim: true,\r\n        inventar: {\r\n          select: {\r\n            inventarId: true,\r\n            emri: true,\r\n            kodi: true,\r\n            marka: true,\r\n            modeli: true,\r\n            cmimiBlerje: true,\r\n            cmimiShitje: true,\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    const daljeList = daljeRows.map((x) => {\r\n      const sasia = Number(x.sasia ?? 0);\r\n\r\n      const cmimiBlerje = Number(x.inventar?.cmimiBlerje?.toString?.() ?? 0);\r\n      const cmimiShitje = Number(x.inventar?.cmimiShitje?.toString?.() ?? 0);\r\n\r\n      const kosto = Number((sasia * cmimiBlerje).toFixed(2));\r\n      const shitje = Number((sasia * cmimiShitje).toFixed(2));\r\n      const fitim = Number((shitje - kosto).toFixed(2));\r\n\r\n      return {\r\n        levizjeId: String(x.levizjeId),\r\n        data: x.data ? new Date(x.data).toISOString() : null,\r\n        sasia,\r\n        cmimiBlerje,\r\n        cmimiShitje,\r\n        kosto,\r\n        shitje,\r\n        fitim,\r\n        shenim: x.shenim ? String(x.shenim) : null,\r\n        pjese: {\r\n          inventarId: String(x.inventar?.inventarId ?? \"\"),\r\n          emri: String(x.inventar?.emri ?? \"Pjesë\"),\r\n          kodi: x.inventar?.kodi ? String(x.inventar.kodi) : null,\r\n          marka: x.inventar?.marka ? String(x.inventar.marka) : null,\r\n          modeli: x.inventar?.modeli ? String(x.inventar.modeli) : null,\r\n        },\r\n      };\r\n    });\r\n\r\n    const daljeKostoTotal = Number(\r\n      daljeList.reduce((s: number, x: any) => s + (Number(x.kosto) || 0), 0).toFixed(2)\r\n    );\r\n    const daljeShitjeTotal = Number(\r\n      daljeList.reduce((s: number, x: any) => s + (Number(x.shitje) || 0), 0).toFixed(2)\r\n    );\r\n    const daljeFitimTotal = Number(\r\n      daljeList.reduce((s: number, x: any) => s + (Number(x.fitim) || 0), 0).toFixed(2)\r\n    );\r\n\r\n    // Borxh (info) – vetëm për faturat e asaj dite\r\n    const borxhInfo = Math.max(0, teHyraFatura - pagesaAplikuar);\r\n\r\n    // Cash i ditës (pagesa aplikuar + bakshish)\r\n    const teHyraCash = pagesaAplikuar + bakshishNgaPagesat;\r\n\r\n    // Fitim neto (cash - kosto - shpenzime)\r\n    const fitimNeto = teHyraCash - daljeKostoTotal - shpenzimeTjera;\r\n\r\n    return NextResponse.json({\r\n      ok: true,\r\n      date: iso,\r\n\r\n      teHyraFatura: Number(teHyraFatura.toFixed(2)),\r\n\r\n      pagesaAplikuar: Number(pagesaAplikuar.toFixed(2)),\r\n      bakshish: Number(bakshishNgaPagesat.toFixed(2)),\r\n      teHyraCash: Number(teHyraCash.toFixed(2)),\r\n\r\n      // kosto pjesësh = kosto blerje nga dalje\r\n      kostoPjesesh: daljeKostoTotal,\r\n      shpenzimeTjera: Number(shpenzimeTjera.toFixed(2)),\r\n      fitimNeto: Number(fitimNeto.toFixed(2)),\r\n\r\n      borxhInfo: Number(borxhInfo.toFixed(2)),\r\n\r\n      shpenzimeList,\r\n\r\n      // ✅ inventar dalje list + totale\r\n      daljeList,\r\n      daljeKostoTotal,\r\n      daljeShitjeTotal,\r\n      daljeFitimTotal,\r\n    });\r\n  } catch (e: any) {\r\n    console.error(\"GET /api/raporte/ditore error:\", e);\r\n    return NextResponse.json(\r\n      { error: \"Gabim te raporti ditor\", detail: String(e?.message ?? e) },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}